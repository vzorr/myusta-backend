image: node:18

pipelines:
  branches:
    dev:
      - step:
          name: ğŸš€ Deploy to Server via SSH (Step-by-Step)
          caches:
            - node
          script:
            - echo "ğŸ” Setting up SSH key..."
            - echo "$SSH_PRIVATE_KEY" > key.pem
            - chmod 600 key.pem

            - echo "ğŸ”§ Connecting to server and running step-by-step deployment..."
            - |
              ssh -v -o StrictHostKeyChecking=no -i key.pem root@47.254.134.96 '
                echo "ğŸ“ Step 1: Changing directory..." &&
                cd /root/myusta-backend &&

                echo "ğŸ“¥ Step 2: Pulling latest code..." &&
                git pull origin dev &&

                echo "ğŸ“¦ Step 3: Installing dependencies..." &&
                npm install &&

                echo "ğŸš€ Step 4: Restarting or starting PM2 process..." &&
                pm2 restart usta-app || pm2 start src/index.js --name usta-app &&

                echo "âœ… Step 5: Deployment successful!"
